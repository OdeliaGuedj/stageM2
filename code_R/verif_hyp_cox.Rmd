---
title: "R Notebook"
output: html_notebook
---

# 1. Vérification des hypothèses des modèles de cox univariés

## 1.1 Risques proportionnels 

### 1.1.1 Avec le deces comme outcome

Plot des résidus de schonfeld 
```{r}
g = c()
for(var in test_univar_deces){
  cox = coxph(Surv(time_to_deces,deces)~data2[,var], data = data2)
  schon.test = cox.zph(cox)
  g = c(g,ggcoxzph(schon.test) + 
          ylab(" ") + 
          xlab(paste("p=", signif(schon.test$table[2,3],2))) +
          ggtitle(names_echotracking[which(echotracking == var)])
        )
}
```

```{r}
grid.arrange(grobs = g, nrow = 5, ncol = 4)
```

plot des du log(-log(S(t))) pour la variable binaire (présence de plaques).

```{r}
plot (survfit(Surv(time_to_deces, deces) ~ plaques, data = data2), fun = "cloglog")
```

### 1.1.2 Avec le CHD comme outcome


```{r}
g = c()
for(var in test_univar_chd){
  cox = coxph(Surv(time_to_chd,chd)~data2[,var], data = data2)
  schon.test = cox.zph(cox)
  g = c(g,ggcoxzph(schon.test) + 
          ylab(" ") + 
          xlab(paste("p=", signif(schon.test$table[2,3],2))) +
          ggtitle(names_echotracking[which(echotracking == var)]) 
        )
}
```

```{r}
grid.arrange(grobs = g, nrow = 5, ncol = 3)
```


```{r}
plot (survfit(Surv(time_to_chd, chd) ~ plaques, data = data2), fun = "cloglog")
```
## 1.2 Log Linéarité

### 1.2.1 Avec le deces comme outcome

#### Méthode du livre de biostat
```{r}
table_verif_deces = c()
for(var in test_univar_deces){
  if(is.numeric(data2[,var])){
    
    out_idx = cut_outlier_quantile(var,data2,0.0035)$out_idx

    tmp_tab = verifHyp_loglin_coxUnivar(var,"time_to_deces","deces",data2,nb.class = 6, method = "mean")
    
    tmp_tab_noOut = verifHyp_loglin_coxUnivar(var,"time_to_deces","deces",data2[-out_idx,],nb.class = 6)
    
     tmp_name = matrix(c(names_echotracking[which(var == echotracking)],rep(" ",5)), ncol = 6)
     colnames(tmp_name) = colnames(tmp_tab)
     
     tmp_nameNoOut = matrix(c(paste(names_echotracking[which(var == echotracking)],"NO OUTLIERS"),rep(" ",5)), ncol = 6)
     colnames(tmp_nameNoOut) = colnames(tmp_tab)
     
     tab = rbind(tmp_name,tmp_tab,tmp_nameNoOut,tmp_tab_noOut)
  }
  table_verif_deces = rbind(table_verif_deces,tab)
}
rm(var)
```


```{r}
kable(table_verif_deces, longtable = T) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

#### Plot des résidus martingales

```{r}
g = c()
for(var in test_univar_deces){
  if(is.numeric(data2[,var])){
    data_tmp = data2[which(!(is.na(data2[,var]))),]
    cox = coxph(Surv(time_to_deces, deces) ~ data_tmp[,var], data = data_tmp)
    g = c(g,ggcoxfunctional(cox, data = data_tmp)+xlab(var))
  }
}
```
```{r}
grid.arrange(grobs = g, nrow = 6, ncol = 3)
```


### 1.2.1 Avec le CHD comme outcome

#### Méthode du livre de biostat
```{r}
for(var in test_univar_deces){
  if(is.numeric(data2[,var])){
    print(var)
  print(verifHyp_loglin_coxUnivar(var,"time_to_chd","chd",data2,nb.class = 10))}
}
```


#### Plot des résidus martingales

```{r}
g = c()
for(var in test_univar_chd){
  if(is.numeric(data2[,var])){
    data_tmp = data2[which(!(is.na(data2[,var]))),]
    cox = coxph(Surv(time_to_chd, chd) ~ data_tmp[,var], data = data_tmp)
    g = c(g,ggcoxfunctional(cox, data = data_tmp))
  }
}
```
```{r}
grid.arrange(grobs = g, nrow = 6, ncol = 3)
```


# ```{r}
#  for(var in test_univar_deces){
#    plot(main =var,log(survfit(coxph(Surv(time_to_deces,deces) ~ data2[,var], data = data2))$time),log(-log(survfit(coxph(Surv(time_to_deces,deces) ~ data2[,var], data = data2))$surv)))
#  }
# ```


# 2. Vérification des hypothèses des modèles de cox multivariés
