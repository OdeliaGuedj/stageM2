---
title: "R Notebook"
output: html_notebook
---

# 0. Packages

```{r}
library(tidyverse)
library(lubridate)
library(survival)
library(survminer)
library(Hmisc)
library(ggplot2)
library(ggcorrplot)
library(kableExtra)
library(gridExtra)
library(ggrepel)
library(knitr)
library(cowplot)
library(compareGroups)
library(table1)
library(mice)
library(factoextra)
library(FactoMineR)
library(mclust)
library(questionr)
library(naniar)
library(corrplot)
library(lsr)
```

# 1. Reading the data

```{r}
data = read.csv2("C:/Users/odeli/Desktop/stageM2/data/EPP3.csv", sep = ";", header = T)
data_supp = read.csv2("C:/Users/odeli/Desktop/stageM2/data/EPP3_supp.csv", sep = ";", header = T)
```
```{r}
data = cbind(data, data_supp[,3:13])
rm(data_supp)
```


# 2. Noms et types des variables


```{r}
colnames(data)[86] = "plaques"
colnames(data)[15] = "pad"
colnames(data)[14] = "pas"
colnames(data)[17] = "diam_bm"
colnames(data)[18] = "imt" 
colnames(data)[19] = "diam_fbm"
colnames(data)[20] = "distension"
```

```{r}
factor = c("sexe", "adm14", "qm9", "qm10", "qm16", "tdr","aomi","stroke","chd","deces", "deptot", "diab", "hypolip2", "antihta2", "educ","sens_hf_t_phase", "sens_phase_hf_c", "sens_phase", "qm34","qm35","qm36","qm37","qm38","qm39","qm40","qm41", "atcdcv", "plaques")
int = c("nepp3", "n__ipc")
date = c("datnaiss", "datinclu", "date_tdr", "date_aomi", "date_stroke", "date_chd", "date_deces")

for(var in colnames(data)){
  if(var %in% factor) {data[,var] = as.factor(data[,var])}
  else if(var%in% int) data[,var] = as.integer(as.character(data[,var]))
  else if(var %in% date) data[,var] = lubridate::dmy(data[,var])
  else data[,var] = as.numeric(as.character(data[,var]))
}
rm(var)
rm(factor)
rm(int)
rm(date)
```

# 3. Ajout de variables générées

## 3.1 Echotracking et mean blood pressure
```{r}
data$logain = as.numeric(log(data$lf_gain_max*100))
data$logyoung = as.numeric(log(data$young))
data$dextdias = as.numeric(data$diam_bm*1000)
data$stiffness = as.numeric(sqrt(1/(data$coeffDist)*1000))
```

## 3.2 Mean Blood Pressure
```{r}
data$mbp = as.numeric((data$pas+ 2*data$pad)/3)
```

```{r}
data$mbp_cat = quantileCut(data$mbp, 4)
table(data$mbp_cat)
```



## 3.2 Groupes d'hypertension
```{r}
data$HTA_cat = NA
data$HTA_cat[data$pas < 120 & data$pad < 80] = "0-Normal"
data$HTA_cat[data$pas < 130 & data$pas >= 120 & data$pad < 80] = "1-High"
data$HTA_cat[(data$pas < 140 & data$pas >= 130) | (data$pad < 90 & data$pad >= 80)] = "2-HBP Stage 1"
data$HTA_cat[data$pas >= 140 | data$pad >= 90] = "3-HBP Stage 2"
data$HTA_cat[data$pas >= 180 | data$pad >= 120] = "4-HBP Crisis"
```
```{r}
table(data$HTA_cat, useNA = "ifany")
```


```{r}
data$age_cat = quant.cut(data$age0, 4)
```

# 4. Prevalence de maladies cardiovasculaires

8 catégories:
- qm34 Infartcus du myocarde
- qm35 Angine de poitrine
- qm36 Souffle au coeur
- qm37 Autre problème cardiaque
- qm38 Maladie des artères
- qm39 Phlébite
- qm40 Embolie pulmonaire
- qm41 AVC
- atcdcv Antécédent cardiovasculaire (qm34 ou qm35 ou qm41)


```{r}
data$prevalence_cvd = 'tmp'
for(i in 1: nrow(data)){
  if(is.na(data$qm34[i]) | is.na(data$qm35[i]) | is.na(data$qm36[i]) | is.na(data$qm37[i]) | is.na(data$qm38[i]) | is.na(data$qm39[i]) | is.na(data$qm40[i]) | is.na(data$qm41[i]))
      data$prevalence_cvd[i] = 0
  else if(data$qm34[i] == 0 & data$qm35[i] == 0 & data$qm36[i] == 0 & data$qm37[i] == 0 & data$qm38[i] == 0 & data$qm39[i] == 0 & data$qm40[i] == 0 & data$qm41[i] == 0)
    data$prevalence_cvd[i] = 0

    else
      data$prevalence_cvd[i] = 1
}
rm(i)
data$prevalence_cvd = as.factor(data$prevalence_cvd)
```


```{r}
table(data$atcdcv, useNA = "always")
```
```{r}
data$atcdcv[is.na(data$atcdcv)] = 0
data$atcdcv = as.factor(data$atcdcv)
```


# 5. Creation des variables time_to_event 

Pour les evt == 1 time_to_event = nbr de jours entre inclusion et evenement
Pour les evt == 0 time_to_event = nbr de jours total d'observation du sujet = nbr de jour entre inclusion et date de dernières nouvelles

```{r}
data$time_to_deces = as.numeric(difftime(data$date_deces, data$datinclu, unit = "days"))
data$time_to_stroke = as.numeric(difftime(data$date_stroke, data$datinclu, unit = "days"))
data$time_to_aomi = as.numeric(difftime(data$date_aomi, data$datinclu, unit = "days"))
data$time_to_chd = as.numeric(difftime(data$date_chd, data$datinclu, unit = "days"))
data$time_to_tdr = as.numeric(difftime(data$date_tdr, data$datinclu, unit = "days"))
```

# 6. Création des variables age_at_event
```{r}
data$age_at_deces = round(as.numeric(difftime(data$date_deces, data$datnaiss, unit = "days"))/365,2)

data$age_at_stroke = round(as.numeric(difftime(data$date_stroke, data$datnaiss, unit = "days"))/365,2)

data$age_at_aomi = round(as.numeric(difftime(data$date_aomi, data$datnaiss, unit = "days"))/365,2)

data$age_at_chd = round(as.numeric(difftime(data$date_chd, data$datnaiss, unit = "days"))/365,2)

data$age_at_tdr = round(as.numeric(difftime(data$date_tdr, data$datnaiss, unit = "days"))/365,2)
```

# 7. Création variable année de naissance + catégorisation

```{r}
year_naiss = as.numeric(format(as.Date(data$datnaiss, format="%Y/%m/%d"),"%Y"))
data$year_naiss = year_naiss
```
```{r}
year_naiss_cat = quantileCut(year_naiss,5)
data$year_naiss_cat = year_naiss_cat
```

# 8. Classif des catégories de variables

```{r}
id = c("nepp3","n__ipc")

date = c("datnaiss", "datinclu", "date_tdr", "date_aomi", "date_stroke", "date_chd", "date_deces")

var_evt = c("deces","stroke","aomi","tdr","chd")

time_to_evt = c("time_to_stroke", "time_to_aomi", "time_to_tdr", "time_to_chd","time_to_deces")

age_at_evt = c("age_at_stroke", "age_at_aomi", "age_at_tdr", "age_at_chd","age_at_deces")

prev_cvd = c("qm34","qm35","qm36","qm37","qm38","qm39","qm40","qm41","atcdcv","prevalence_cvd")

socio_demo = c("age0", "age_cat", "sexe","adm14","educ")

qual_vie = c("qm9","qm10","qm16","bmi","diab","deptot","epice")

traitement = c("antihta2", "hypolip2")

bio = c("trb17", "ldl","bio10","mbp","bio6", "pa_cat", "mbp_cat","pas","pad")

echotracking =  c("fc_basale","diam_bm","imt","diam_fbm","distension","pwvloc", "dploc","debut","dist_rate_moy","dist_rate_var","rr_int_moy","rr_int_var","lf_dist_rate_t","hf_dist_rate_t","hf_dist_rate_c","lf_rrint_t","hf_rr_int_t","hf_rrint_c","freq_resp","lf_coh_max","lf_coh_moy","lf_gain_max","lf_gain_moy","lf_phase","sens_phase","hf_c_coh_max","hf_c_coh_moy","hf_c_gain_max","hf_c_gain_moy","hf_c_phase","sens_phase_hf_c","hf_t_coh_max","hf_t_coh_moy","hf_t_gain_max","hf_t_gain_moy","hf_t_phase","sens_hf_t_phase","dist_moy","dist_var","cws","coeffDist","compli","wcsa","young","plaques","logain","logyoung","dextdias","stiffness")

names_echotracking = c("Basale cardiac rate", "Diastolic outer diameter (bm)", "Itima Media Thickness","Diastolic Outer Diameter (fbm)","Distension", "Pulse Wave Velocity","Central Pulse Pressure",  "Bigining", "Distension Rate (Mean)", "Distension Rate (Variance)", "RR interval (Mean)","RR interval (Variance)", "Low frequency Distension Rate (t)","High frequency Distension rate (t)","High frequency Distension Rate (c)", "Low frequency RR interval (t)", "High frequency RR interval (t)","High frequency RR interval (c)", "Respiratory rate", "Low frequency COH (Max)","Low frequency COH (Mean)","Low frequency Gain (Max)","Low frequency Gain (Mean)","Low frequency phase","Sens phase","High frequency COH (Max) (c)","High frequency COH (Mean) (c)", "High frequency Gain (Max) (c)","High frequency Gain (Mean) (c)","High frequency phase (c)", "High frequency sens phase (c)","High frequency COH (Max) (t)","High frequency COH (Mean) (t)","High frequency Gain (Max) (t)","High frequency Gain (Mean) (t)", "High frequency phase (t)","High freqeuncy sens_phase (t)","Distension (Mean)","Distension (Variance)","Circumferential Wall Stress","Coefficient of distensibility","Cross Sectional Compliance", "Wall Cross Sectionnal Area", "Young Module","Presence of plaques","Gain (log)", "Young Module (log)","Diastolic outer diameter (bm*1000)","Stiffness")

echotracking_clean =  c("fc_basale","diam_bm","imt","distension","pwvloc", "dploc","dist_rate_moy","rr_int_moy","lf_dist_rate_t","hf_dist_rate_t","hf_dist_rate_c","lf_rrint_t","hf_rr_int_t","hf_rrint_c","freq_resp","lf_coh_moy","lf_gain_moy","hf_c_coh_moy","hf_c_gain_moy","hf_t_coh_moy","hf_t_gain_moy","dist_moy","cws","coeffDist","compli","wcsa","young","plaques","logain","logyoung","dextdias","stiffness")

var_et_jpe_tot = c("diam_bm", "imt", "distension", "dploc", "dist_rate_moy",  "rr_int_moy","lf_dist_rate_t","hf_dist_rate_t","lf_rrint_t","hf_rr_int_t","lf_coh_moy", "hf_c_coh_moy", "hf_c_gain_moy", "cws","coeffDist", "compli", "wcsa", "young","logain","stiffness")

var_et_jpe_inf = c("diam_bm" , "imt", "distension", "dploc", "dist_rate_moy","coeffDist", "young","logain","stiffness")

param_carotid = c("logain", "coeffDist","pwvloc", "dploc", "logyoung","imt", "dextdias", "stiffness", "plaques")
```



# 9. Création d'une base de données centrée réduite

```{r}
data_std = data
for(var in colnames(data)){
  if(is.numeric(data[,var]) & !(is.integer(data[,var]))){
    data_std[,var] = (data[,var]-mean(data[,var], na.rm = T))/sd(data[,var], na.rm = T)
  }
}
rm(var)
```

# 10. Création base de données sans les prévalents cvd

On retire les patients ayant des antécédants de maladie cardiovasculaire.
```{r}
data2 = subset(data,data$atcdcv == "0")
data2_std = subset(data_std,data_std$atcdcv == "0")
```