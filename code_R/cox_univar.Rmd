---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# 0. Préliminaires

Necessaire que les evt soient numériques sinon pas pris en charge par la fonction coxph.

```{r}
 for(evt in var_evt){
   data[,evt] = as.numeric(as.character(data[,evt]))
   data2[,evt] = as.numeric(as.character(data2[,evt]))
   data_std[,evt] = as.numeric(as.character(data_std[,evt]))
   data2_std[,evt] = as.numeric(as.character(data2_std[,evt]))
   }
```



# 1 Paramètres carotidiens prioritaires issus analyses déjà faites (9)


```{r}
# i = 1
# list_univar_pc = list()
# list_univarSTD_pc = list()
# 
# for(evt in var_evt){
#   
#   time = paste0("time_to_",evt)
#   res_univar_pc = data.frame()
#   res_univarSTD_pc = data.frame()
#   
#   for(var in param_carotid){
#     
#     cox = cox_univar(time, var, evt, data2)
#     coxSTD = cox_univar(time, var, evt, data2_std)
#     
#     res_univar_pc = rbind(res_univar_pc, cox$res_df)
#     res_univarSTD_pc = rbind(res_univarSTD_pc, coxSTD$res_df)
#   }
#   
#   res_univar_pc$Evt = rep(evt,nrow(res_univar_pc))
#   res_univarSTD_pc$Evt = rep(evt,nrow(res_univarSTD_pc))
#   
#   list_univar_pc[[i]] = res_univar_pc
#   list_univarSTD_pc[[i]] = res_univarSTD_pc
#   
#   i = i + 1
# }
# rm(i);
# rm(res_univar_pc);rm(res_univarSTD_pc);
# rm(cox);rm(coxSTD)
# 
# names(list_univar_pc) = var_evt
# names(list_univarSTD_pc) = var_evt
```


```{r}
# list_univar_pc[["deces"]]
# list_univar_pc[["chd"]]
```


# 2 Modèls de Cox univariés pour toutes les variables d'échotracking (clean)

Ici avec l'argument round = F pour pouvoir tracer le graph

(Ici seulement pour death et chd, on peut étendre aux autres evt : modifier boucle for et les deux dernières lignes (names))
```{r}
# i = 1
# list_univar_et = list()
# list_univarSTD_et = list()
# 
# for(evt in c("deces","chd")){
#   
#   time = paste0("time_to_",evt)
#   res_univar_et = data.frame()
#   res_univarSTD_et = data.frame()
#   
#   for(var in echotracking_clean){
#     
#     cox = cox_univar(time, var, evt, data2, round = F)
#     coxSTD = cox_univar(time, var, evt, data2_std, round = F)
#     
#     res_univar_et = rbind(res_univar_et, cox)
#     res_univarSTD_et = rbind(res_univarSTD_et, coxSTD)
#   }
#   
#   res_univar_et$Evt = rep(evt,nrow(res_univar_et))
#   res_univarSTD_et$Evt = rep(evt,nrow(res_univarSTD_et))
#   
#   list_univar_et[[i]] = res_univar_et
#   list_univarSTD_et[[i]] = res_univarSTD_et
#   
#   i = i + 1
# }
# rm(i);
# rm(res_univar_et); rm(res_univarSTD_et);
# rm(cox);rm(coxSTD)
# 
# names(list_univar_et) = c("deces","chd")
# names(list_univarSTD_et) = c("deces","chd")
```

```{r}
# list_univar_et[["deces"]]
# list_univar_et[["chd"]]
```
```{r echo=FALSE}
# plot_grid(plot_pv_HR(list_univar_et[["deces"]]),
#           plot_pv_HR(list_univar_et[["chd"]]))
```

# 3 Modèles de cox univariés pour param selectionnées par tests

## 3.1 Death

### 3.1.1 Time on study as time scale
```{r}
list_univar_et_deces = list()
list_univar_et_deces_std = list()
evt = "deces"
time = paste0("time_to_",evt)
res_univar_et_deces = data.frame()
res_univar_et_deces_std = data.frame()
  
for(var in test_univar){
  cox = cox_univar(time, var, evt, data2, round = F)
  cox_std = cox_univar(time, var, evt, data2_std, round = F)
  res_univar_et_deces = rbind(res_univar_et_deces, cox)
  res_univar_et_deces_std = rbind(res_univar_et_deces_std, cox_std)
  }
  
res_univar_et_deces$Evt = rep(evt,nrow(res_univar_et_deces))
res_univar_et_deces_std$Evt = rep(evt,nrow(res_univar_et_deces_std))

list_univar_et_deces[[evt]] = res_univar_et_deces
list_univar_et_deces_std[[evt]] = res_univar_et_deces_std

rm(res_univar_et_deces);
rm(res_univar_et_deces_std);
rm(cox);
rm(cox_std);
rm(evt);
rm(time);

list_univar_et_deces = list_univar_et_deces$deces
list_univar_et_deces_std = list_univar_et_deces_std$deces
```


```{r}
plot_pv_HR3(list_univar_et_deces_std)
```

### 3.1.2 Age as time scale
```{r}
list_univar_et_deces_as = list()
list_univar_et_deces_as_std = list()
evt = "deces"
time = paste0("age_at_",evt)
res_univar_et_deces_as = data.frame()
res_univar_et_deces_as_std = data.frame()
  
for(var in test_univar){
  cox_as = cox_univar(time, var, evt, data2, round = F)
  cox_as_std = cox_univar(time, var, evt, data2_std, round = F)
  res_univar_et_deces_as = rbind(res_univar_et_deces_as, cox_as)
  res_univar_et_deces_as_std = rbind(res_univar_et_deces_as_std, cox_as_std)
  }
  
res_univar_et_deces_as$Evt = rep(evt,nrow(res_univar_et_deces_as))
res_univar_et_deces_as_std$Evt = rep(evt,nrow(res_univar_et_deces_as_std))

list_univar_et_deces_as[[evt]] = res_univar_et_deces_as
list_univar_et_deces_as_std[[evt]] = res_univar_et_deces_as_std

rm(res_univar_et_deces_as);
rm(res_univar_et_deces_as_std);
rm(cox_as);
rm(cox_as_std);
rm(evt);
rm(time);

list_univar_et_deces_as = list_univar_et_deces_as$deces
list_univar_et_deces_as_std = list_univar_et_deces_as_std$deces
```


```{r}
plot_pv_HR3(list_univar_et_deces_as_std)
```

## 3.2 Coronary Heart disease

### 3.2.1 Time on study as time scale
```{r}
list_univar_et_chd = list()
list_univar_et_chd_std = list()
evt = "chd"
time = paste0("time_to_",evt)
res_univar_et_chd = data.frame()
res_univar_et_chd_std = data.frame()

for(var in test_univar){
  cox = cox_univar(time, var, evt, data2, round = F)
  cox_std = cox_univar(time, var, evt, data2_std, round = F)
  res_univar_et_chd = rbind(res_univar_et_chd, cox)
  res_univar_et_chd_std = rbind(res_univar_et_chd_std, cox_std)
  }
  
res_univar_et_chd$Evt = rep(evt,nrow(res_univar_et_chd))
res_univar_et_chd_std$Evt = rep(evt,nrow(res_univar_et_chd_std))
list_univar_et_chd[[evt]] = res_univar_et_chd
list_univar_et_chd_std[[evt]] = res_univar_et_chd_std

rm(res_univar_et_chd);
rm(res_univar_et_chd_std);
rm(cox);
rm(cox_std);
rm(evt);
rm(time);

list_univar_et_chd = list_univar_et_chd$chd
list_univar_et_chd_std = list_univar_et_chd_std$chd

```

```{r}
list_univar_et_chd
```
```{r}
plot_pv_HR3(list_univar_et_chd_std)
```

### 3.2.2 Age as time scale
```{r}
list_univar_et_chd_as = list()
list_univar_et_chd_as_std = list()
evt = "chd"
time = paste0("age_at_",evt)
res_univar_et_chd_as = data.frame()
res_univar_et_chd_as_std = data.frame()

for(var in test_univar){
  cox_as = cox_univar(time, var, evt, data2, round = F)
  cox_as_std = cox_univar(time, var, evt, data2_std, round = F)
  res_univar_et_chd_as = rbind(res_univar_et_chd_as, cox_as)
  res_univar_et_chd_as_std = rbind(res_univar_et_chd_as_std, cox_as_std)
  }
  
res_univar_et_chd_as$Evt = rep(evt,nrow(res_univar_et_chd_as))
res_univar_et_chd_as_std$Evt = rep(evt,nrow(res_univar_et_chd_as_std))
list_univar_et_chd_as[[evt]] = res_univar_et_chd_as
list_univar_et_chd_as_std[[evt]] = res_univar_et_chd_as_std

rm(res_univar_et_chd_as);
rm(res_univar_et_chd_as_std);
rm(cox_as);
rm(cox_as_std);
rm(evt);
rm(time);

list_univar_et_chd_as = list_univar_et_chd_as$chd
list_univar_et_chd_as_std = list_univar_et_chd_as_std$chd
```

```{r}
plot_pv_HR3(list_univar_et_chd_as_std)
```
## 3.3 Tableau résultats

```{r}
test_univar_names = c()
for(var in test_univar){
  test_univar_names = c(test_univar_names,names_echotracking[which(var == echotracking)])
}
```

```{r}
res_cox_univar_tab = data.frame(
  "Names" = test_univar_names ,
  "HR_univar_deces" = round(list_univar_et_deces$HR,2),
  "IC_univar_deces" = paste("[",round(list_univar_et_deces$ICinf,2),";",round(list_univar_et_deces$ICsup,2),"]"),
  "p_univar_deces" = signif(list_univar_et_deces$p.value,2),
  "HR_univar_chd" = round(list_univar_et_chd$HR,2),
  "IC_univar_chd" = paste("[",round(list_univar_et_chd$ICinf,2),";",round(list_univar_et_chd$ICsup,2),"]"),
  "p_univar_chd" = round(signif(list_univar_et_chd$p.value,2),3)
  )


res_cox_univar_tab_std = data.frame(
  "Names" = test_univar_names,
  "HR_univar_deces" = round(list_univar_et_deces_std$HR,2),
  "IC_univar_deces" = paste("[",round(list_univar_et_deces_std$ICinf,2),";",round(list_univar_et_deces_std$ICsup,2),"]"),
  "p_univar_deces" = signif(list_univar_et_deces_std$p.value,2),
  "HR_univar_chd" = round(list_univar_et_chd_std$HR,2),
  "IC_univar_chd" = paste("[",round(list_univar_et_chd_std$ICinf,2),";",round(list_univar_et_chd_std$ICsup,2),"]"),
  "p_univar_chd" = round(signif(list_univar_et_chd_std$p.value,2),3)
  )
```


```{r}
kable(res_cox_univar_tab, longtable = T, caption = "Cox univariés sur données brutes") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```
```{r}
kable(res_cox_univar_tab_std, longtable = T, caption = "Cox univariés sur données scaled") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```
## 3.4 Stockage des param signif

On stock les param signif dans cox univarié et verifiant hypothèses
```{r}
cox_univar_deces = as.character(list_univar_et_deces$Name[list_univar_et_deces$pv_signif == 1 ])

cox_univar_chd = as.character(list_univar_et_chd$Name[list_univar_et_chd$pv_signif == 1])
```
```{r}
length(cox_univar_deces)
length(cox_univar_chd)
```

On joint les deux vecteurs (deces et chd) en virant les doublons

```{r}
cox_univar_all = unique(c(cox_univar_deces, cox_univar_chd))
```

```{r}
length(cox_univar_all)
```





