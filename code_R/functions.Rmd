---
title: "R Notebook"
output: html_notebook
---


Permet de faire des modèles de cox univariés et d'avoir les resultats sous la forme extract_coxReg (donc dataframe).

```{r}
cox_univar = function(time, var, evt, dt, round = T, d.round = 2, alpha = 0.05, interaction = F, var.inter){
  
  # time : time-to-event
  # evt : variable d'evenement (binaire)
  # var : liste de variables explicatives
  # dt : dateframe contennant toues les var citées plus haut
  # round : variable booléenne d'arondis, F par défaut. Valeur T utile pour les graphes
  # d.round : nb de décimale conservée aprés arrondis, 2 par défaut
  # alpha : risque de première éspèce. 5% par défaut
  # interaction : variable booléenne sur inclusion d'une interraction. FALSE par defaut
  # var.inter : variable d'interraction, uniquement si interraction vaut TRUE
  
  
  # On s'assure que le time-to-event et l'event sont bien numériques
  time = as.numeric(as.character(dt[,time]))
  evt = as.numeric(as.character(dt[,evt]))
  
  # On fit le modèle
  if(interaction == T){
    model = coxph(Surv(time,evt) ~ dt[,var] + dt[,var]*dt[,var.inter], data = dt)}
  else
    model = coxph(Surv(time,evt) ~ dt[,var], data = dt)
  
  summary = summary(model)
  
  #test de shonfeld pour vérifier l'hypothèse de proportionnalité des risques
  test.shonfeld = cox.zph(model)
  
  # Construction du dataframe final arrondi ou non
  if (round == T){
    
    df = data.frame("Name" = var,
                    "HR" = round(summary$coefficient[length(summary$coefficient[,2]),2],d.round),
                    "IC" = paste0("[", round(summary$conf.int[length(summary$conf.int[,3]),3],d.round +1), " ; ", ... = round(summary$conf.int[length(summary$conf.int[,4]),4],d.round+1), "]"),
                    "p.value" = signif(summary$coefficient[length(summary$coefficient[,5]),5],3),
                    "pv_signif" = ifelse(summary$coefficient[length(summary$coefficient[,5]),5] <= alpha, "*"," "),
                    "p.shonfeld" = signif(test.shonfeld$table[dim(test.shonfeld$table)[1],dim(test.shonfeld$table)[2]],d.round+1),
                    "n" = model$n,
                    "n.events" = model$nevent
                    )
    
    
   return(list("res_df"=df, "model" = model))
  } 
  
  else if (round == F){
    
    df = data.frame("Name" = var,
                    "HR" = summary$coefficient[length(summary$coefficient[,2]),2],
                    "ICinf" = summary$conf.int[length(summary$conf.int[,3]),3],
                    "ICsup" = summary$conf.int[length(summary$conf.int[,4]),4],
                    "p.value" = summary$coefficient[length(summary$coefficient[,5]),5],
                    "pv_signif" = ifelse(summary$coefficient[length(summary$coefficient[,5]),5] <= alpha, 1,0),
                    "p.shonfeld" = signif(test.shonfeld$table[dim(test.shonfeld$table)[1],dim(test.shonfeld$table)[2]],d.round+1),
                    "Hyp.Prop.verif" = ifelse(test.shonfeld$table[dim(test.shonfeld$table)[1],dim(test.shonfeld$table)[2]] <= alpha ,0,1),
                    "n" = model$n,
                    "n.events" = model$nevent
                    )
  
    return(df)
  
  }
}
```


Permet d'afficher les HR  de modèles univariés (Autant de paramètres qu'on veut pour 1 evenement particulier) avec un code couleur pour leur significativité.



```{r}
plot_pv_HR  = function(cox_nice_info, hj = 0, vj = 0, main = " "){
  
  # Pour pouvoir utiliser cette fonction il faut que cox_nice_info soit un objet cox_univar ou cox_multivar utilisé avec l'argument round = F
  
  # Extraction des noms des param et
  tmp = c()
  for(var in cox_nice_info$Name)
    {tmp = c(tmp,which(echotracking == var))}
  cox_nice_info$Name_nice = names_echotracking[tmp]
  
  # Colonne pour couleur et legende
   for(i in 1:nrow(cox_nice_info)){
     if(cox_nice_info[i,"pv_signif"] == 1 & 
      cox_nice_info[i,"Hyp.Prop.verif"] == 1 & 
      cox_nice_info[i,"HR"] <= 1)
       {cox_nice_info[i,"col"] = 1}
     else if (cox_nice_info[i,"pv_signif"] == 1 & 
            cox_nice_info[i,"Hyp.Prop.verif"] == 1 & 
            cox_nice_info[i,"HR"] > 1)
      {cox_nice_info[i,"col"] = 2}
     else if (cox_nice_info[i,"pv_signif"] == 0 & 
            cox_nice_info[i,"Hyp.Prop.verif"] == 1)
      {cox_nice_info[i,"col"] = 3}
     else if (cox_nice_info[i,"Hyp.Prop.verif"] == 0)
     {cox_nice_info[i,"col"] = 4}
   }
  cox_nice_info$col = as.factor(cox_nice_info$col)
  
  
  ggplot(cox_nice_info,aes(p.value, HR, color = col)) +

  geom_point(size = 3) +
  
  scale_color_manual(labels = c("Deleterious effect","Protective effect", "Non significant","Hyp non verified"), values=c('aquamarine3','coral2','red','black')) +

  scale_y_continuous(name="HR",limits=c(min(cox_nice_info$HR)-0.1 , max(cox_nice_info$HR)+0.1)) +
    

  theme_classic() +

  geom_text_repel(aes(label = Name_nice),
                  segment.colour = NA,
                  box.padding   = 0.35,
                  point.padding = 0.5,
                  #segment.color = "black",
                  force = 15,
                  segment.size  = .7 ,#epaisseur segments
                  size = 3 #taille label
                     ) +


  labs(title = main, y = "Hazard Ratio", x = "p value", color = " ")
  
  #return(cox_nice_info[1,"pv_signif"])
  
}
```
Permet de fiter des régressions de cox multivariées et de récupérer les info du dernier coefficients qui correspond au paramètre d'échotracking que l'on étudie.

```{r}
cox_multivar = function(formula, list_param, dt, round = T, d.round = 2){
  
  df_res = data.frame()
  
    for(param in list_param){
      
      f = update(formula, as.formula( paste0(".~.+",param) ) )
      cox = coxph(f, data)
      summary = summary(cox)
      test.shonfeld = cox.zph(cox)
      
      # Pour pouvoir acceder a dernier élément du tableau qui correspond au paramètre d'échotracking qu'on rajoute à la fin de chaque formula
      r = nrow(summary$coefficients) 
      
      if(round == T){
          df_tmp = data.frame("Name" = rownames(summary$coefficients)[r],
                    "HR" = round(summary$coefficient[r,2],d.round),
                    "IC" = paste0("[", round(summary$conf.int[r,3],d.round), " ; ",round(summary$conf.int[r,4],d.round), "]"),
                    "p.value" = signif(summary$coefficient[r,5],d.round+3),
                    "Signif" = ifelse(summary$coefficient[r,5] <= 0.05, "*"," "),
                    "p.shonfeld" = signif(test.shonfeld$table[dim(test.shonfeld$table)[1],3],d.round+1),
                    "prop.hyp" = ifelse(test.shonfeld$table[dim(test.shonfeld$table)[1],3] < 0.05,"X"," "))
      
      }
      else if(round == F){
        df_tmp = data.frame("Name" = rownames(summary$coefficients)[r],
                    "HR" = summary$coefficient[r,2],
                    "ICinf" = summary$conf.int[r,3],
                    "ICsup" = summary$conf.int[r,4],
                    "p.value" = signif(summary$coefficient[r,5],d.round+3),
                    "p.shonfeld" = signif(test.shonfeld$table[dim(test.shonfeld$table)[1],3],d.round+1),
                    "Hyp.Prop.verif" = ifelse(test.shonfeld$table[dim(test.shonfeld$table)[1],3] <= 0.05 ,0,1))
        df_tmp$pv_signif = ifelse(df_tmp$p.value <= 0.05 , 1, 0)
        
      }
      
      df_res = rbind(df_res,df_tmp)
      }
  return(df_res)
}
```
```{r}
generate_str_var = function(list_var){
  str = NULL
  for(var in list_var){
    tmp = paste("+",var)
    str = paste0(str,tmp)
  }
  str = substr(str,2,nchar(str))
  return(str)
}
```
