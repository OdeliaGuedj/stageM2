---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---
 



# 0. Préliminaires

Necessaire que les evt soient numériques sinon pas pris en charge par la fonction coxph.

```{r}
 for(evt in var_evt){
   data[,evt] = as.numeric(as.character(data[,evt]))
   data2[,evt] = as.numeric(as.character(data2[,evt]))
   data_std[,evt] = as.numeric(as.character(data_std[,evt]))
   data2_std[,evt] = as.numeric(as.character(data2_std[,evt]))
   }
```



# 1. Modèles de Cox

Les analyses déjà faites avaient la structure suivante
1. Univarié
2. Modèle 1: age + sexe + tabac + activité physique
3. Modèle 2: Modèle 1 + diabète + créatinine
4. Modèle 3: Modèle 2 + bmi
5. Modèle 4: Modèle 3 + mean blood pressure






# 2. Modèles univariés

## 2.1 Paramètres carotidiens prioritaires issus analyses déjà faites (9)


```{r}
i = 1
list_univar_pc = list()
list_univarSTD_pc = list()

for(evt in var_evt){
  
  time = paste0("time_to_",evt)
  res_univar_pc = data.frame()
  res_univarSTD_pc = data.frame()
  
  for(var in param_carotid){
    
    cox = cox_univar(time, var, evt, data2)
    coxSTD = cox_univar(time, var, evt, data2_std)
    
    res_univar_pc = rbind(res_univar_pc, cox$res_df)
    res_univarSTD_pc = rbind(res_univarSTD_pc, coxSTD$res_df)
  }
  
  res_univar_pc$Evt = rep(evt,nrow(res_univar_pc))
  res_univarSTD_pc$Evt = rep(evt,nrow(res_univarSTD_pc))
  
  list_univar_pc[[i]] = res_univar_pc
  list_univarSTD_pc[[i]] = res_univarSTD_pc
  
  i = i + 1
}
rm(i)

names(list_univar_pc) = var_evt
names(list_univarSTD_pc) = var_evt
```


```{r}
list_univar_pc[["deces"]]
list_univar_pc[["chd"]]
```


## 2.2 Modèls de Cox univariés pour toutes les variables d'échotracking (clean)

Ici avec l'argument round = F pour pouvoir tracer le graph


```{r}
i = 1
list_univar_et = list()
list_univarSTD_et = list()

for(evt in c("deces","chd")){
  
  time = paste0("time_to_",evt)
  res_univar_et = data.frame()
  res_univarSTD_et = data.frame()
  
  for(var in echotracking_clean){
    
    cox = cox_univar(time, var, evt, data2, round = F)
    coxSTD = cox_univar(time, var, evt, data2_std, round = F)
    
    res_univar_et = rbind(res_univar_et, cox)
    res_univarSTD_et = rbind(res_univarSTD_et, coxSTD)
  }
  
  res_univar_et$Evt = rep(evt,nrow(res_univar_et))
  res_univarSTD_et$Evt = rep(evt,nrow(res_univarSTD_et))
  
  list_univar_et[[i]] = res_univar_et
  list_univarSTD_et[[i]] = res_univarSTD_et
  
  i = i + 1
}
rm(i)

names(list_univar_et) = c("deces","chd")
names(list_univarSTD_et) = c("deces","chd")
```
```{r}
list_univar_et[["deces"]]
```




```{r}
plot_grid(
  plot_pv_HR(list_univar_et[["deces"]]),
  plot_pv_HR(list_univar_et[["chd"]])
)
```
```{r}
list_univar_et[["deces"]]
```
## 2.3 Modèles de cox univariés pour param selectionnées par tests

```{r}
i = 1
list_univar_et_deces = list()
#list_univarSTD_et = list()

for(evt in c("deces")){
  
  time = paste0("time_to_",evt)
  res_univar_et_deces = data.frame()
  #res_univarSTD_et = data.frame()
  
  for(var in var_et_deces_univar){
    
    cox = cox_univar(time, var, evt, data2, round = F)
    #coxSTD = cox_univar(time, var, evt, data2_std, round = F)
    
    res_univar_et_deces = rbind(res_univar_et_deces, cox)
    #res_univarSTD_et = rbind(res_univarSTD_et, coxSTD)
  }
  
  res_univar_et_deces$Evt = rep(evt,nrow(res_univar_et_deces))
  #res_univarSTD_et$Evt = rep(evt,nrow(res_univarSTD_et))
  
  list_univar_et_deces[[i]] = res_univar_et_deces
  #list_univarSTD_et[[i]] = res_univarSTD_et
  
  i = i + 1
}
rm(i)

names(list_univar_et_deces) = "deces"
#names(list_univarSTD_et) = var_evt
```


```{r}
i = 1
list_univar_et_chd = list()
#list_univarSTD_et = list()

for(evt in c("chd")){
  
  time = paste0("time_to_",evt)
  res_univar_et_chd = data.frame()
  #res_univarSTD_et = data.frame()
  
  for(var in var_et_chd_univar){
    
    cox = cox_univar(time, var, evt, data2, round = F)
    #coxSTD = cox_univar(time, var, evt, data2_std, round = F)
    
    res_univar_et_chd = rbind(res_univar_et_chd, cox)
    #res_univarSTD_et = rbind(res_univarSTD_et, coxSTD)
  }
  
  res_univar_et_chd$Evt = rep(evt,nrow(res_univar_et_chd))
  #res_univarSTD_et$Evt = rep(evt,nrow(res_univarSTD_et))
  
  list_univar_et_chd[[i]] = res_univar_et_chd
  #list_univarSTD_et[[i]] = res_univarSTD_et
  
  i = i + 1
}
rm(i)

names(list_univar_et_chd) = "chd"
#names(list_univarSTD_et) = var_evt
```

```{r}
plot_pv_HR(list_univar_et_deces[["deces"]])
plot_pv_HR(list_univar_et_chd[["chd"]])
```


On stock les param signif dans cox univarié et verifiant hypothèses
```{r}
param_et_select_univar_deces = as.character(list_univar_et_deces[["deces"]]$Name[list_univar_et_deces[["deces"]]$pv_signif == 1 & list_univar_et_deces[["deces"]]$Hyp.Prop.verif == 1])

param_et_select_univar_chd = as.character(list_univar_et_chd[["chd"]]$Name[list_univar_et_chd[["chd"]]$pv_signif == 1 & list_univar_et_chd[["chd"]]$Hyp.Prop.verif == 1])
```

On joint les deux vecteurs (deces et chd) en virant les doublons

```{r}
param_et_select_univar = unique(c(param_et_select_univar_deces, param_et_select_univar_chd))
```


```{r}
# param_for_cor = param_et_select_univar[sapply(data2[,param_et_select_univar],is.numeric)]
# cor(data2[,param_for_cor], use = "complete.obs")
```


# 3. Modèles multivariés

## 3.1 Les modèles des analyses déjà effectuées (uniquement à baseline) et sur les param_selectionnées

### 3.1.1 Deces

```{r}
f1_deces_brut_ss_prevcvd = formula(Surv(time_to_deces,deces) ~ age0 + sexe + qm16 + qm10, env = data2)

f2_deces_brut_ss_prevcvd = formula(Surv(time_to_deces,deces) ~ age0 + sexe + qm16 + qm10 + diab + bio10, env = data2)

f3_deces_brut_ss_prevcvd = formula(Surv(time_to_deces,deces) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi, env = data2)

f4_deces_brut_ss_prevcvd = formula(Surv(time_to_deces,deces) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

f5_deces_brut_ss_prevcvd = formula(Surv(time_to_deces,deces) ~ sexe + qm16 + qm10 + diab + bio10 + bmi + mbp , env = data2)
```
```{r}
m1_deces_brut_ss_prevcvd = cox_multivar(f1_deces_brut_ss_prevcvd,param_et_select_univar_deces,data2, round = F)
m2_deces_brut_ss_prevcvd = cox_multivar(f2_deces_brut_ss_prevcvd,param_et_select_univar_deces,data2, round = F)
m3_deces_brut_ss_prevcvd = cox_multivar(f3_deces_brut_ss_prevcvd,param_et_select_univar_deces,data2, round = F)
m4_deces_brut_ss_prevcvd = cox_multivar(f4_deces_brut_ss_prevcvd,param_et_select_univar_deces,data2, round = F)
m5_deces_brut_ss_prevcvd = cox_multivar(f5_deces_brut_ss_prevcvd,param_et_select_univar_deces,data2, round = F)
```


```{r}
plot_grid(
plot_pv_HR(m1_deces_brut_ss_prevcvd) + ggtitle("Modèle 1"),
plot_pv_HR(m2_deces_brut_ss_prevcvd) + ggtitle("Modèle 2"),
plot_pv_HR(m3_deces_brut_ss_prevcvd) + ggtitle("Modèle 3"),
plot_pv_HR(m4_deces_brut_ss_prevcvd) + ggtitle("Modèle 4"))

```
```{r}
plot_grid(
  plot_pv_HR(m4_deces_brut_ss_prevcvd) + ggtitle("Modèle 4"),
  plot_pv_HR(m5_deces_brut_ss_prevcvd) + ggtitle("Modèle 5"))
```
```{r}
m1_deces_brut_ss_prevcvd
m4_deces_brut_ss_prevcvd
```

### 3.1.2 Aomi

```{r}
f1_aomi_brut_ss_prevcvd = formula(Surv(time_to_aomi,aomi) ~ age0 + sexe + qm16 + qm10, env = data2)

f2_aomi_brut_ss_prevcvd = formula(Surv(time_to_aomi,aomi) ~ age0 + sexe + qm16 + qm10 + diab + bio10, env = data2)

f3_aomi_brut_ss_prevcvd = formula(Surv(time_to_aomi,aomi) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi, env = data2)

f4_aomi_brut_ss_prevcvd = formula(Surv(time_to_aomi,aomi) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

liste_f_aomi_brut_ss_prevcvd = c(f1_aomi_brut_ss_prevcvd,f1_aomi_brut_ss_prevcvd,f1_aomi_brut_ss_prevcvd,f1_aomi_brut_ss_prevcvd,f1_aomi_brut_ss_prevcvd)
```
```{r}
m1_aomi_brut_ss_prevcvd = cox_multivar(f1_aomi_brut_ss_prevcvd,param_carotid,data2, round = F)
m2_aomi_brut_ss_prevcvd = cox_multivar(f2_aomi_brut_ss_prevcvd,param_carotid,data2, round = F)
m3_aomi_brut_ss_prevcvd = cox_multivar(f3_aomi_brut_ss_prevcvd,param_carotid,data2, round = F)
m4_aomi_brut_ss_prevcvd = cox_multivar(f4_aomi_brut_ss_prevcvd,param_carotid,data2, round = F)
```

```{r}
plot_grid(
plot_pv_HR(m1_aomi_brut_ss_prevcvd),
plot_pv_HR(m2_aomi_brut_ss_prevcvd),
plot_pv_HR(m3_aomi_brut_ss_prevcvd),
plot_pv_HR(m4_aomi_brut_ss_prevcvd))
```
### 3.1.3 TDR
```{r}
f1_tdr_brut_ss_prevcvd = formula(Surv(time_to_tdr,tdr) ~ age0 + sexe + qm16 + qm10, env = data2)

f2_tdr_brut_ss_prevcvd = formula(Surv(time_to_tdr,tdr) ~ age0 + sexe + qm16 + qm10 + diab + bio10, env = data2)

f3_tdr_brut_ss_prevcvd = formula(Surv(time_to_tdr,tdr) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi, env = data2)

f4_tdr_brut_ss_prevcvd = formula(Surv(time_to_tdr,tdr) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

liste_f_tdr_brut_ss_prevcvd = c(f1_tdr_brut_ss_prevcvd,f1_tdr_brut_ss_prevcvd,f1_tdr_brut_ss_prevcvd,f1_tdr_brut_ss_prevcvd,f1_tdr_brut_ss_prevcvd)
```
```{r}
m1_tdr_brut_ss_prevcvd = cox_multivar(f1_tdr_brut_ss_prevcvd,param_carotid,data2, round = F)
m2_tdr_brut_ss_prevcvd = cox_multivar(f2_tdr_brut_ss_prevcvd,param_carotid,data2, round = F)
m3_tdr_brut_ss_prevcvd = cox_multivar(f3_tdr_brut_ss_prevcvd,param_carotid,data2, round = F)
m4_tdr_brut_ss_prevcvd = cox_multivar(f4_tdr_brut_ss_prevcvd,param_carotid,data2, round = F)
```

```{r}
plot_grid(
plot_pv_HR(m1_tdr_brut_ss_prevcvd),
plot_pv_HR(m2_tdr_brut_ss_prevcvd),
plot_pv_HR(m3_tdr_brut_ss_prevcvd),
plot_pv_HR(m4_tdr_brut_ss_prevcvd))
```
### 3.1.4 CHD

```{r}
f1_chd_brut_ss_prevcvd = formula(Surv(time_to_chd,chd) ~ age0 + sexe + qm16 + qm10, env = data2)

f2_chd_brut_ss_prevcvd = formula(Surv(time_to_chd,chd) ~ age0 + sexe + qm16 + qm10 + diab + bio10, env = data2)

f3_chd_brut_ss_prevcvd = formula(Surv(time_to_chd,chd) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi, env = data2)

f4_chd_brut_ss_prevcvd = formula(Surv(time_to_chd,chd) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

f5_chd_brut_ss_prevcvd = formula(Surv(time_to_chd,chd) ~ sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

```
```{r}
m1_chd_brut_ss_prevcvd = cox_multivar(f1_chd_brut_ss_prevcvd,param_et_select_univar_chd,data2, round = F)
m2_chd_brut_ss_prevcvd = cox_multivar(f2_chd_brut_ss_prevcvd,param_et_select_univar_chd,data2, round = F)
m3_chd_brut_ss_prevcvd = cox_multivar(f3_chd_brut_ss_prevcvd,param_et_select_univar_chd,data2, round = F)
m4_chd_brut_ss_prevcvd = cox_multivar(f4_chd_brut_ss_prevcvd,param_et_select_univar_chd,data2, round = F)
m4_chd_brut_ss_prevcvd = cox_multivar(f4_chd_brut_ss_prevcvd,param_et_select_univar_chd,data2, round = F)
m5_chd_brut_ss_prevcvd = cox_multivar(f5_chd_brut_ss_prevcvd,param_et_select_univar_chd,data2, round = F)
```

```{r}
plot_grid(
plot_pv_HR(m1_chd_brut_ss_prevcvd) + ggtitle("Modèle 1"),
plot_pv_HR(m2_chd_brut_ss_prevcvd) + ggtitle("Modèle 2"),
plot_pv_HR(m3_chd_brut_ss_prevcvd) + ggtitle("Modèle 3"),
plot_pv_HR(m4_chd_brut_ss_prevcvd) + ggtitle("Modèle 4"))
```
```{r}
plot_grid(
  plot_pv_HR(m4_chd_brut_ss_prevcvd) + ggtitle("Modèle 4"),
  plot_pv_HR(m5_chd_brut_ss_prevcvd) + ggtitle("Modèle 5")
)
```
### 3.1.5 Stroke

```{r}
f1_stroke_brut_ss_prevcvd = formula(Surv(time_to_stroke,stroke) ~ age0 + sexe + qm16 + qm10, env = data2)

f2_stroke_brut_ss_prevcvd = formula(Surv(time_to_stroke,stroke) ~ age0 + sexe + qm16 + qm10 + diab + bio10, env = data2)

f3_stroke_brut_ss_prevcvd = formula(Surv(time_to_stroke,stroke) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi, env = data2)

f4_stroke_brut_ss_prevcvd = formula(Surv(time_to_stroke,stroke) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

liste_f_stroke_brut_ss_prevcvd = c(f1_stroke_brut_ss_prevcvd,f1_stroke_brut_ss_prevcvd,f1_stroke_brut_ss_prevcvd,f1_stroke_brut_ss_prevcvd,f1_stroke_brut_ss_prevcvd)
```
```{r}
m1_stroke_brut_ss_prevcvd = cox_multivar(f1_stroke_brut_ss_prevcvd,param_carotid,data2, round = F)
m2_stroke_brut_ss_prevcvd = cox_multivar(f2_stroke_brut_ss_prevcvd,param_carotid,data2, round = F)
m3_stroke_brut_ss_prevcvd = cox_multivar(f3_stroke_brut_ss_prevcvd,param_carotid,data2, round = F)
m4_stroke_brut_ss_prevcvd = cox_multivar(f4_stroke_brut_ss_prevcvd,param_carotid,data2, round = F)
```


```{r}
plot_grid(
plot_pv_HR(m1_stroke_brut_ss_prevcvd),
plot_pv_HR(m2_stroke_brut_ss_prevcvd),
plot_pv_HR(m3_stroke_brut_ss_prevcvd),
plot_pv_HR(m4_stroke_brut_ss_prevcvd))
```



# 4. Modèle 4 avec plusieurs var d'et pour le deces et le chd






```{r}
cox_multivar_multi_param = function(evt, list_param, list_var_ajust, dt, round = T, d.round = 2){
  
  time = paste0("time_to_",evt)
  evt = as.numeric(as.character(data2[,evt]))
  time = as.numeric(as.character(data2[,time]))
  param = generate_str_var(list_param)
  var_ajust = generate_str_var(list_var_ajust)
  f = formula(paste("Surv(time, evt)~", generate_str_var(list_param),"+" ,generate_str_var(list_var_ajust)))
  
  cox = coxph(f,dt)
  summary = summary(cox)
  test.shonfeld = cox.zph(cox)
  
  df_res = data.frame()

    
  r = sum(sapply(dt[,list_param], is.numeric))
  for(p in list_param){if(is.factor(dt[,p])){r = r + length(levels(dt[,p])) - 1 }}

      if(round == T){
          df_tmp = data.frame("Name" = rownames(summary$coefficients)[1:r],
                    "HR" = round(summary$coefficient[1:r,2],d.round),
                    "IC" = paste0("[", round(summary$conf.int[1:r,3],d.round), " ; ",round(summary$conf.int[r,4],d.round), "]"),
                    "p.value" = signif(summary$coefficient[1:r,5],d.round+3),
                    "Signif" = ifelse(summary$coefficient[1:r,5] <= 0.05, "*"," "),
                    "p.shonfeld" = signif(test.shonfeld$table[1:r,3],d.round+1),
                    
                    "prop.hyp" = ifelse(test.shonfeld$table[1:r,3] < 0.05,"X"," ")
                    )

      }
       else if(round == F){
         df_tmp = data.frame("Name" = rownames(summary$coefficients)[1:r],
                     "HR" = summary$coefficient[1:r,2],
                     "ICinf" = summary$conf.int[1:r,3],
                     "ICsup" = summary$conf.int[1:r,4],
                     "p.value" = signif(summary$coefficient[1:r,5],d.round+3),
                     "p.shonfeld" = signif(test.shonfeld$table[1:r,3],d.round+1),
                     "Hyp.Prop.verif" = ifelse(test.shonfeld$table[1:r,3] <= 0.05 ,0,1))
         df_tmp$pv_signif = ifelse(df_tmp$p.value <= 0.05 , 1, 0)
       
       
       
       df_res = rbind(df_res,df_tmp)
       }


  return(df_res)
}
```


```{r}
var_ajust_m4 = c("age0",  "sexe",  "qm16",  "qm10",  "diab",  "bio10", "bmi",   "mbp" )
var_et_deces_m4 = as.character(m4_deces_brut_ss_prevcvd$Name[m4_deces_brut_ss_prevcvd$pv_signif == 1])
var_et_deces_m4[4] = "pr_sence_de_plaque_s____l__cho"
var_et_chd_m4 = as.character(m4_chd_brut_ss_prevcvd$Name[m4_chd_brut_ss_prevcvd$pv_signif == 1])
var_et_chd_m4[6] = "pr_sence_de_plaque_s____l__cho"
```


```{r}
m4_deces = cox_multivar_multi_param("deces",var_et_deces_m4,var_ajust_m4,data2, round = F)
plot_pv_HR(m4_deces)
```

```{r}
m4_chd = cox_multivar_multi_param("chd",var_et_chd_m4,var_ajust_m4,data2, round = F)
plot_pv_HR(m4_chd)
```


