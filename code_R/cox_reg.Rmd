---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---
 



# 0. Préliminaires

Necessaire que les evt soient numériques sinon pas pris en charge par la fonction coxph.

```{r}
 for(evt in var_evt){
   data[,evt] = as.numeric(as.character(data[,evt]))
   data2[,evt] = as.numeric(as.character(data2[,evt]))
   data_std[,evt] = as.numeric(as.character(data_std[,evt]))
   data2_std[,evt] = as.numeric(as.character(data2_std[,evt]))
   }
```



# 1. Fonctions pour modèles de Cox

Les analyses déjà faites avaient la structure suivante
1. Univarié
2. Modèle 1: age + sexe + tabac + activité physique
3. Modèle 2: Modèle 1 + diabète + créatinine
4. Modèle 3: Modèle 2 + bmi
5. Modèle 4: Modèle 3 + mean blood pressure

Mais convenu avec JPE (mais bon vite fait au tel):
1. Univarié
2. Modèle 1: age + sexe + educ + statut marital
3. Modèle 2: Modèle 1 + tabac + bmi + hdl
4. Modèle 3: Modèle 2 + mean blood pressure




## 1.1 Fonction cox_univar
Permet de faire des modèles de cox univariés et d'avoir les resultats sous la forme extract_coxReg (donc dataframe).
ça sera utile quand on devra faire toutes les analyses univariées des paramètres d'echotracking (presque 51 paramètres) pour chachun des evts (5) -> 255 models...
```{r}
cox_univar = function(time, var, evt, dt, round = T, d.round = 2, alpha = 0.05){
  
  # time : time-to-event
  # evt : variable d'evenement (binaire)
  # var : liste de variables explicatives
  # dt : dateframe contennant toues les var citées plus haut
  # round : variable booléenne d'arondis, F par défaut. Valeur T utile pour les graphes
  # d.round : nb de décimale conservée aprés arrondis, 2 par défaut
  # alpha : risque de première éspèce. 5% par défaut
  
  
  
  # On s'assure que le time-to-event et l'event sont bien numériques
  time = as.numeric(as.character(dt[,time]))
  evt = as.numeric(as.character(dt[,evt]))
  
  # On fit le modèle
  model = coxph(Surv(time,evt) ~ dt[,var], data = dt)
  summary = summary(model)
  
  #test de shonfeld pour vérifier l'hypothèse de proportionnalité des risques
  test.shonfeld = cox.zph(model)
  
  # Construction du dataframe final arrondi ou non
  if (round == T){
    
    df = data.frame("Name" = var,
                    "HR" = round(summary$coefficient[,2],d.round),
                    "IC" = paste0("[", round(summary$conf.int[,3],d.round +1), " ; ", ... = round(summary$conf.int[,4],d.round+1), "]"),
                    "p.value" = signif(summary$coefficient[,5],3),
                    "pv_signif" = ifelse(summary$coefficient[,5] <= alpha, "*"," "),
                    "p.shonfeld" = signif(test.shonfeld$table[,3],d.round+1),
                    "n" = model$n,
                    "n.events" = model$nevent)
    
    
   return(list("res_df"=df, "model" = model))
  } 
  
  else if (round == F){
    
    df = data.frame("Name" = var,
                    "HR" = summary$coefficient[,2],
                    "ICinf" = summary$conf.int[,3],
                    "ICsup" = summary$conf.int[,4],
                    "p.value" = summary$coefficient[,5],
                    "pv_signif" = ifelse(summary$coefficient[,5] <= alpha, 1,0),
                    "p.shonfeld" = signif(test.shonfeld$table[,3],d.round+1),
                    "Hyp.Prop.verif" = ifelse(test.shonfeld$table[,3] <= alpha ,0,1),
                    "n" = model$n,
                    "n.events" = model$nevent)
  
    return(df)
  
  }
}
```


## 1.2 Fonction plot_pv_HR
Permet d'afficher les HR  de modèles univariés (Autant de paramètres qu'on veut pour 1 evenement particulier) avec un code couleur pour leur significativité.

```{r}
plot_pv_HR = function(cox_nice_info, hj = 0, vj = 0, main = " "){
  
  # Pour pouvoir utiliser cette fonction il faut que cox_nice_info soit un objet cox_univar ou cox_multivar utilisé avec l'argument round = F
  
  ggplot(cox_nice_info, aes(p.value, HR)) + 
    
    geom_point(color = dplyr::case_when((cox_nice_info$pv_signif == 1 & cox_nice_info$Hyp.Prop.verif == 1)~ "green", (cox_nice_info$pv_signif == 0 & cox_nice_info$Hyp.Prop.verif == 1) ~ "red",cox_nice_info$Hyp.Prop.verif == 0 ~ "black" )) +
    
      geom_hline(yintercept = 1) +
    
        scale_y_continuous(name="HR",limits=c(min(cox_nice_info$HR)-0.1 , max(cox_nice_info$HR)+0.1)) +
            
    geom_text_repel(aes(label = Name), box.padding   = 0.35, point.padding = 0.5, segment.color = "grey50", force = 15,
                    segment.size  = 0.5 ,#epaisseur segments
                    size = 3 #taille label 
                    )+
    
            xlab("p.values") +
        
              ggtitle(main)
  
}
```

## 1.3 Fonction cox_multivar pour les var d'et prises une à une.

Permet de fiter des régressions de cox multivariées et de récupérer les info du dernier coefficients qui correspond au paramètre d'échotracking que l'on étudie.

```{r}
cox_multivar = function(formula, list_param, dt, round = T, d.round = 2){
  
  df_res = data.frame()
  
    for(param in list_param){
      
      f = update(formula, as.formula( paste0(".~.+",param) ) )
      cox = coxph(f, data)
      summary = summary(cox)
      test.shonfeld = cox.zph(cox)
      
      # Pour pouvoir acceder a dernier élément du tableau qui correspond au paramètre d'échotracking qu'on rajoute à la fin de chaque formula
      r = nrow(summary$coefficients) 
      
      if(round == T){
          df_tmp = data.frame("Name" = rownames(summary$coefficients)[r],
                    "HR" = round(summary$coefficient[r,2],d.round),
                    "IC" = paste0("[", round(summary$conf.int[r,3],d.round), " ; ",round(summary$conf.int[r,4],d.round), "]"),
                    "p.value" = signif(summary$coefficient[r,5],d.round+3),
                    "Signif" = ifelse(summary$coefficient[r,5] <= 0.05, "*"," "),
                    "p.shonfeld" = signif(test.shonfeld$table[dim(test.shonfeld$table)[1],3],d.round+1),
                    "prop.hyp" = ifelse(test.shonfeld$table[dim(test.shonfeld$table)[1],3] < 0.05,"X"," "))
      
      }
      else if(round == F){
        df_tmp = data.frame("Name" = rownames(summary$coefficients)[r],
                    "HR" = summary$coefficient[r,2],
                    "ICinf" = summary$conf.int[r,3],
                    "ICsup" = summary$conf.int[r,4],
                    "p.value" = signif(summary$coefficient[r,5],d.round+3),
                    "p.shonfeld" = signif(test.shonfeld$table[dim(test.shonfeld$table)[1],3],d.round+1),
                    "Hyp.Prop.verif" = ifelse(test.shonfeld$table[dim(test.shonfeld$table)[1],3] <= 0.05 ,0,1))
        df_tmp$pv_signif = ifelse(df_tmp$p.value <= 0.05 , 1, 0)
        
      }
      
      df_res = rbind(df_res,df_tmp)
      }
  return(df_res)
}
```

# 2. Modèles univariés

## 2.1 Paramètres carotidiens prioritaires issus analyses déjà faites (9)


```{r}
param_carotid = c("logain", "coeffDist","pwvloc", "dploc", "logyoung","imt___m_", "dextdias", "stiffness", "pr_sence_de_plaque_s____l__cho")
```


```{r}
i = 1
list_univar_pc = list()
list_univarSTD_pc = list()

for(evt in var_evt){
  
  time = paste0("time_to_",evt)
  res_univar_pc = data.frame()
  res_univarSTD_pc = data.frame()
  
  for(var in param_carotid){
    
    cox = cox_univar(time, var, evt, data2)
    coxSTD = cox_univar(time, var, evt, data2_std)
    
    res_univar_pc = rbind(res_univar_pc, cox$res_df)
    res_univarSTD_pc = rbind(res_univarSTD_pc, coxSTD$res_df)
  }
  
  res_univar_pc$Evt = rep(evt,nrow(res_univar_pc))
  res_univarSTD_pc$Evt = rep(evt,nrow(res_univarSTD_pc))
  
  list_univar_pc[[i]] = res_univar_pc
  list_univarSTD_pc[[i]] = res_univarSTD_pc
  
  i = i + 1
}
rm(i)

names(list_univar_pc) = var_evt
names(list_univarSTD_pc) = var_evt
```

Exemple de ce que ça donne:
```{r}
list_univar_pc[["deces"]]
list_univarSTD_pc[["deces"]]
```


## 2.2 Modèls de Cox univariés pour toutes les variables numériques d'échotracking

202 modèles à faire et à synthétiser donc ça prends un peu de temps à tourner.
```{r}
which(unlist(lapply(data2[,echotracking],is.factor)) == TRUE)
```

Ici avec l'argument round = F pour pouvoir tracer le graph
```{r}
echotracking_ss_sens = echotracking[-c(27,33,39)]
i = 1
list_univar_et = list()
list_univarSTD_et = list()

for(evt in var_evt){
  
  time = paste0("time_to_",evt)
  res_univar_et = data.frame()
  res_univarSTD_et = data.frame()
  
  for(var in echotracking_ss_sens){
    
    cox = cox_univar(time, var, evt, data2, round = F)
    coxSTD = cox_univar(time, var, evt, data2_std, round = F)
    
    res_univar_et = rbind(res_univar_et, cox)
    res_univarSTD_et = rbind(res_univarSTD_et, coxSTD)
  }
  
  res_univar_et$Evt = rep(evt,nrow(res_univar_et))
  res_univarSTD_et$Evt = rep(evt,nrow(res_univarSTD_et))
  
  list_univar_et[[i]] = res_univar_et
  list_univarSTD_et[[i]] = res_univarSTD_et
  
  i = i + 1
}
rm(i)

names(list_univar_et) = var_evt
names(list_univarSTD_et) = var_evt
```
```{r}
list_univar_et[["deces"]]
```




```{r}
plot_grid(
  plot_pv_HR(list_univar_et[["deces"]]),
  plot_pv_HR(list_univarSTD_et[["deces"]])
)
```
```{r}
list_univar_et[["deces"]]
```

<!-- # ```{r} -->
<!-- # et_signif_deces =  -->
<!-- # et_signif_aomi =  -->
<!-- # et_signif_tdr =  -->
<!-- # et_signif_chd =  -->
<!-- # et_signif_stroke =  -->
<!-- # ``` -->


# 3. Modèles multivariés

## 3.1 Les modèles des analyses déjà effectuées (uniquement à baseline) et sur les 9 param caro

### 3.1.1 Deces
```{r}
f1_deces_brut_ss_prevcvd = formula(Surv(time_to_deces,deces) ~ age0 + sexe + qm16 + qm10, env = data2)

f2_deces_brut_ss_prevcvd = formula(Surv(time_to_deces,deces) ~ age0 + sexe + qm16 + qm10 + diab + bio10, env = data2)

f3_deces_brut_ss_prevcvd = formula(Surv(time_to_deces,deces) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi, env = data2)

f4_deces_brut_ss_prevcvd = formula(Surv(time_to_deces,deces) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

liste_f_deces_brut_ss_prevcvd = c(f1_deces_brut_ss_prevcvd,f1_deces_brut_ss_prevcvd,f1_deces_brut_ss_prevcvd,f1_deces_brut_ss_prevcvd,f1_deces_brut_ss_prevcvd)
```
```{r}
m1_deces_brut_ss_prevcvd = cox_multivar(f1_deces_brut_ss_prevcvd,param_carotid,data2, round = F)
m2_deces_brut_ss_prevcvd = cox_multivar(f2_deces_brut_ss_prevcvd,param_carotid,data2, round = F)
m3_deces_brut_ss_prevcvd = cox_multivar(f3_deces_brut_ss_prevcvd,param_carotid,data2, round = F)
m4_deces_brut_ss_prevcvd = cox_multivar(f4_deces_brut_ss_prevcvd,param_carotid,data2, round = F)
```

```{r}
plot_grid(
plot_pv_HR(m1_deces_brut_ss_prevcvd),
plot_pv_HR(m2_deces_brut_ss_prevcvd),
plot_pv_HR(m3_deces_brut_ss_prevcvd),
plot_pv_HR(m4_deces_brut_ss_prevcvd))
```
```{r}
m1_deces_brut_ss_prevcvd
m4_deces_brut_ss_prevcvd
```

### 3.1.2 Aomi

```{r}
f1_aomi_brut_ss_prevcvd = formula(Surv(time_to_aomi,aomi) ~ age0 + sexe + qm16 + qm10, env = data2)

f2_aomi_brut_ss_prevcvd = formula(Surv(time_to_aomi,aomi) ~ age0 + sexe + qm16 + qm10 + diab + bio10, env = data2)

f3_aomi_brut_ss_prevcvd = formula(Surv(time_to_aomi,aomi) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi, env = data2)

f4_aomi_brut_ss_prevcvd = formula(Surv(time_to_aomi,aomi) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

liste_f_aomi_brut_ss_prevcvd = c(f1_aomi_brut_ss_prevcvd,f1_aomi_brut_ss_prevcvd,f1_aomi_brut_ss_prevcvd,f1_aomi_brut_ss_prevcvd,f1_aomi_brut_ss_prevcvd)
```
```{r}
m1_aomi_brut_ss_prevcvd = cox_multivar(f1_aomi_brut_ss_prevcvd,param_carotid,data2, round = F)
m2_aomi_brut_ss_prevcvd = cox_multivar(f2_aomi_brut_ss_prevcvd,param_carotid,data2, round = F)
m3_aomi_brut_ss_prevcvd = cox_multivar(f3_aomi_brut_ss_prevcvd,param_carotid,data2, round = F)
m4_aomi_brut_ss_prevcvd = cox_multivar(f4_aomi_brut_ss_prevcvd,param_carotid,data2, round = F)
```

```{r}
plot_grid(
plot_pv_HR(m1_aomi_brut_ss_prevcvd),
plot_pv_HR(m2_aomi_brut_ss_prevcvd),
plot_pv_HR(m3_aomi_brut_ss_prevcvd),
plot_pv_HR(m4_aomi_brut_ss_prevcvd))
```
### 3.1.3 TDR
```{r}
f1_tdr_brut_ss_prevcvd = formula(Surv(time_to_tdr,tdr) ~ age0 + sexe + qm16 + qm10, env = data2)

f2_tdr_brut_ss_prevcvd = formula(Surv(time_to_tdr,tdr) ~ age0 + sexe + qm16 + qm10 + diab + bio10, env = data2)

f3_tdr_brut_ss_prevcvd = formula(Surv(time_to_tdr,tdr) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi, env = data2)

f4_tdr_brut_ss_prevcvd = formula(Surv(time_to_tdr,tdr) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

liste_f_tdr_brut_ss_prevcvd = c(f1_tdr_brut_ss_prevcvd,f1_tdr_brut_ss_prevcvd,f1_tdr_brut_ss_prevcvd,f1_tdr_brut_ss_prevcvd,f1_tdr_brut_ss_prevcvd)
```
```{r}
m1_tdr_brut_ss_prevcvd = cox_multivar(f1_tdr_brut_ss_prevcvd,param_carotid,data2, round = F)
m2_tdr_brut_ss_prevcvd = cox_multivar(f2_tdr_brut_ss_prevcvd,param_carotid,data2, round = F)
m3_tdr_brut_ss_prevcvd = cox_multivar(f3_tdr_brut_ss_prevcvd,param_carotid,data2, round = F)
m4_tdr_brut_ss_prevcvd = cox_multivar(f4_tdr_brut_ss_prevcvd,param_carotid,data2, round = F)
```

```{r}
plot_grid(
plot_pv_HR(m1_tdr_brut_ss_prevcvd),
plot_pv_HR(m2_tdr_brut_ss_prevcvd),
plot_pv_HR(m3_tdr_brut_ss_prevcvd),
plot_pv_HR(m4_tdr_brut_ss_prevcvd))
```
### 3.1.4 CHD

```{r}
f1_chd_brut_ss_prevcvd = formula(Surv(time_to_chd,chd) ~ age0 + sexe + qm16 + qm10, env = data2)

f2_chd_brut_ss_prevcvd = formula(Surv(time_to_chd,chd) ~ age0 + sexe + qm16 + qm10 + diab + bio10, env = data2)

f3_chd_brut_ss_prevcvd = formula(Surv(time_to_chd,chd) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi, env = data2)

f4_chd_brut_ss_prevcvd = formula(Surv(time_to_chd,chd) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

liste_f_chd_brut_ss_prevcvd = c(f1_chd_brut_ss_prevcvd,f1_chd_brut_ss_prevcvd,f1_chd_brut_ss_prevcvd,f1_chd_brut_ss_prevcvd,f1_chd_brut_ss_prevcvd)
```
```{r}
m1_chd_brut_ss_prevcvd = cox_multivar(f1_chd_brut_ss_prevcvd,param_carotid,data2, round = F)
m2_chd_brut_ss_prevcvd = cox_multivar(f2_chd_brut_ss_prevcvd,param_carotid,data2, round = F)
m3_chd_brut_ss_prevcvd = cox_multivar(f3_chd_brut_ss_prevcvd,param_carotid,data2, round = F)
m4_chd_brut_ss_prevcvd = cox_multivar(f4_chd_brut_ss_prevcvd,param_carotid,data2, round = F)
```

```{r}
plot_grid(
plot_pv_HR(m1_chd_brut_ss_prevcvd),
plot_pv_HR(m2_chd_brut_ss_prevcvd),
plot_pv_HR(m3_chd_brut_ss_prevcvd),
plot_pv_HR(m4_chd_brut_ss_prevcvd))
```
### 3.1.5 Stroke

```{r}
f1_stroke_brut_ss_prevcvd = formula(Surv(time_to_stroke,stroke) ~ age0 + sexe + qm16 + qm10, env = data2)

f2_stroke_brut_ss_prevcvd = formula(Surv(time_to_stroke,stroke) ~ age0 + sexe + qm16 + qm10 + diab + bio10, env = data2)

f3_stroke_brut_ss_prevcvd = formula(Surv(time_to_stroke,stroke) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi, env = data2)

f4_stroke_brut_ss_prevcvd = formula(Surv(time_to_stroke,stroke) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)

liste_f_stroke_brut_ss_prevcvd = c(f1_stroke_brut_ss_prevcvd,f1_stroke_brut_ss_prevcvd,f1_stroke_brut_ss_prevcvd,f1_stroke_brut_ss_prevcvd,f1_stroke_brut_ss_prevcvd)
```
```{r}
m1_stroke_brut_ss_prevcvd = cox_multivar(f1_stroke_brut_ss_prevcvd,param_carotid,data2, round = F)
m2_stroke_brut_ss_prevcvd = cox_multivar(f2_stroke_brut_ss_prevcvd,param_carotid,data2, round = F)
m3_stroke_brut_ss_prevcvd = cox_multivar(f3_stroke_brut_ss_prevcvd,param_carotid,data2, round = F)
m4_stroke_brut_ss_prevcvd = cox_multivar(f4_stroke_brut_ss_prevcvd,param_carotid,data2, round = F)
```


```{r}
plot_grid(
plot_pv_HR(m1_stroke_brut_ss_prevcvd),
plot_pv_HR(m2_stroke_brut_ss_prevcvd),
plot_pv_HR(m3_stroke_brut_ss_prevcvd),
plot_pv_HR(m4_stroke_brut_ss_prevcvd))
```






# 4. Modèle 4 multivarié avec chacune des 20 var d'et JPE_tot prises séparément

### 3.1.1 Deces
```{r}
modele_4_formule = formula(Surv(time_to_deces,deces) ~ age0 + sexe + qm16 + qm10 + diab + bio10 + bmi + mbp, env = data2)
```
```{r}
m4 = cox_multivar(modele_4_formule,var_et_jpe_tot,data2, round = F)
```

```{r}
m1_deces_brut_ss_prevcvd = cox_multivar(f1_deces_brut_ss_prevcvd,param_carotid,data2, round = F)
m2_deces_brut_ss_prevcvd = cox_multivar(f2_deces_brut_ss_prevcvd,param_carotid,data2, round = F)
m3_deces_brut_ss_prevcvd = cox_multivar(f3_deces_brut_ss_prevcvd,param_carotid,data2, round = F)
m4_deces_brut_ss_prevcvd = cox_multivar(f4_deces_brut_ss_prevcvd,param_carotid,data2, round = F)
```

```{r}
plot_grid(
plot_pv_HR(m1_deces_brut_ss_prevcvd),
plot_pv_HR(m2_deces_brut_ss_prevcvd),
plot_pv_HR(m3_deces_brut_ss_prevcvd),
plot_pv_HR(m4_deces_brut_ss_prevcvd))
```

