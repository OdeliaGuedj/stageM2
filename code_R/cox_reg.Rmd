---
title: "R Notebook"
output: html_notebook
---
 
# 1. Creation des variables time_to_event 

Pour les evt == 1 time_to_event = nbr de jours entre inclusion et evenement
Pour les evt == 0 time_to_event = nbr de jours total d'observation du sujet = nbr de jour entre inclusion et date de dernières nouvelles

```{r}
data$time_to_deces = as.numeric(difftime(data$date_deces, data$datinclu, unit = "days"))
data$time_to_stroke = as.numeric(difftime(data$date_stroke, data$datinclu, unit = "days"))
data$time_to_aomi = as.numeric(difftime(data$date_aomi, data$datinclu, unit = "days"))
data$time_to_chd = as.numeric(difftime(data$date_chd, data$datinclu, unit = "days"))
data$time_to_tdr = as.numeric(difftime(data$date_tdr, data$datinclu, unit = "days"))
```

```{r}
for(evt in var_evt){
  data[,evt] = as.numeric(as.character(data[,evt]))
}
```

```{r}
time_to_evt = c("time_to_stroke", "time_to_aomi", "time_to_tdr", "time_to_chd","time_to_deces")
```

# 2. Fonctions pour modèles de Cox

Les analyses déjà faites avaient la structure suivante (manque la créatinine: bio10 !!)
1. Univarié
2. Modèle 1: age + sexe + tabac + activité physique
3. Modèle 2: Modèle 1 + diabète + créatinine
4. Modèle 3: Modèle 2 + bmi
5. Modèle 4: Modèle 3 + mean blood pressure

Mais convenu avec JPE (mais bon vite fait au tel):
1. Univarié
2. Modèle 1: age + sexe + educ + statut marital
3. Modèle 2: Modèle 1 + tabac + bmi + hdl
4. Modèle 3: Modèle 2 + mean blood pressure



## 2.1 Fonction extract_coxReg
Permet de récuperer proporement les resultats d'un modèle de cox (à améliorer si jamais on abesoin de plus d'informations par la suite comme nevets, test de vrais, et pvalue associée...)
Ajouter un argument booléen qui permet de sortir le code lates (Kable) plutot qu'un dataframe
```{r}
extract_coxReg = function(cox_model, round = T, alpha = 0.05){
  summary = summary(cox_model)
  if (round == T){
    df = data.frame("Names" = rownames(summary$coefficients),
                    "HR" = round(summary$coefficient[,2],2),
                    "IC" = paste0("[", round(summary$conf.int[,3],3), " ; ", round(summary$conf.int[,4],3), "]"),
                    "p.value" = signif(summary$coefficient[,5],3),
                    "Signif" = ifelse(summary$coefficient[,5] <= 0.05, "*"," "))
  return(df)
  }
  
  else{
    df = data.frame("Names" = rownames(summary$coefficients),
                    "HR" = summary$coefficient[,2],
                    "ICinf" = summary$conf.int[,3],
                    "ICsup" = summary$conf.int[,4],
                    "p.value" = summary$coefficient[,5])
  df$pv_signif = ifelse(df$p.value <= alpha , 1, 0)
  
  return(df)
  
  }
  
}
```

## 2.2 Fonction cox_univar
Permet de faire de smodèles de cox univariés et d'avoir les resultats sous la forme extract_coxReg (donc dataframe).
ça sera utile quand on devra faire toutes les analyses univariées des paramètres d'echotracking (presque 50 paramètres) pour chachun des evts (5) -> 250 models...
```{r}
cox_univar = function(time, var, evt, dt, round = T){
  time = as.numeric(as.character(dt[,time]))
  evt = as.numeric(as.character(dt[,evt]))
  model = coxph(Surv(time,evt) ~ dt[,var], data = dt)
  res = extract_coxReg(model, round)
  res$Names = var
  return(res)
}
```

## 2.3 Fonction plot_pv_HR
Permet d'afficher les HR  de modèles univariés (Autant de paramètres qu'on veux pour 1 evenements particuliers) avec un code couleur pour leur significativité.
```{r}
plot_pv_HR = function(extract_coxReg_obj, hj = 0, vj = 0, main = " "){

  ggplot(extract_coxReg_obj, aes(extract_coxReg_obj$p.value, extract_coxReg_obj$HR)) + 
    geom_point(color = dplyr::case_when(extract_coxReg_obj$pv_signif == 1 ~ "green", 
                                      extract_coxReg_obj$pv_signif == 0 ~ "red")) +
    geom_hline(yintercept = 1) +
    scale_y_continuous(name="HR",limits=c(0,3)) +
    geom_text_repel(aes(label = Names),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = "grey50",
                  force = 15,
                  segment.size  = 0.5 ,#epaisseur segments
                  size = 3 #taille label
    )+
    xlab("p.values")+
    ggtitle(main)
  
}
```



# 3. Modèles univariés

## 3.1 Paramètres carotidiens prioritaires discutés avec JPE (7)

```{r}
param_carotid = c("logain", "coeffDist", "logyoung","imt___m_", "dextdias", "stiffness", "pr_sence_de_plaque_s____l__cho")
```


```{r}
for(evt in var_evt){
  time = paste0("time_to_",evt)
  models_univar_pc = data.frame()
  #print(evt)
  #print(time)
  for(var in param_carotid){
    #print(var)
    models_univar_pc = rbind(models_univar_pc,cox_univar(time, var, evt, data))
    #print(models_univar)
  }
  models_univar_pc$Evt = rep(evt,nrow(models_univar_pc))
  print(models_univar_pc)
}
models_univar_pc
```

## 3.2 Modèls de Cox univariés pour toutes las variables numériques d'échotracking

```{r}
for(evt in var_evt){
  time = paste0("time_to_",evt)
  models_univar_et = data.frame()
  #print(evt)
  #print(time)
  for(var in colnames(data_echo)){
    #print(var)
    models_univar_et = rbind(models_univar_et,cox_univar(time, var, evt, data))
    #print(models_univar)
  }
  models_univar_et$Evt = rep(evt,nrow(models_univar_et))
  print(models_univar_et)
}
```


Exemple avec l'evt deces

```{r}
models_univar_et_deces = data.frame()
evt = "deces"
time = paste0("time_to_",evt)
models_univar_et = data.frame()
for(var in colnames(data_echo)){
  models_univar_et_deces = rbind(models_univar_et_deces,cox_univar(time, var, evt, data, round = F))
  }
  models_univar_et_deces$Evt = rep(evt,nrow(models_univar_et_deces))
  print(models_univar_et_deces)
```
```{r}
plot_pv_HR(models_univar_et_deces, main = "Deces")
```


















## 3.1 Les modèles des analyses déjà effectuées (uniquement à baseline)

### 3.1.1  Log_young

#### 3.1.1.1 Deces

```{r}
data$deces = as.numeric(as.character(data$deces))
logyoung_deces_univar = coxph(Surv(time_to_deces,deces)~ logyoung, data = data)
logyoung_deces_mod1 = coxph(Surv(time_to_deces,deces)~ logyoung + age0 + sexe + qm16 + qm10, data = data)
logyoung_deces_mod2 = coxph(Surv(time_to_deces,deces)~ logyoung + age0 + sexe + qm16 +  qm10 + diab + bio10, data = data)
logyoung_deces_mod3 = coxph(Surv(time_to_deces,deces)~ logyoung + age0 + sexe + qm16 +  qm10 + diab + bio10 + bmi, data = data)
logyoung_deces_mod4 = coxph(Surv(time_to_deces,deces)~ logyoung + age0 + sexe + qm16 +  qm10 + diab + bio10 + bmi + mbp, data = data)
```
```{r}
summary(logyoung_deces_univar)
summary(logyoung_deces_mod4)
```

### 3.1.2. stroke

```{r}
data$stroke = as.numeric(as.character(data$stroke))
logyoung_stroke_univar = coxph(Surv(time_to_stroke,stroke)~ log_young, data = data)
logyoung_stroke_mod1 = coxph(Surv(time_to_stroke,stroke)~ log_young + age0 + sexe + qm16 + qm10, data = data)
logyoung_stroke_mod2 = coxph(Surv(time_to_stroke,stroke)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10, data = data)
logyoung_stroke_mod3 = coxph(Surv(time_to_stroke,stroke)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10 + bmi, data = data)
logyoung_stroke_mod4 = coxph(Surv(time_to_stroke,stroke)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10 + bmi + mbp, data = data)
```
```{r}
summary(logyoung_stroke_univar)
summary(logyoung_stroke_mod1)
```

### 3.1.3 chd

```{r}
data$chd = as.numeric(as.character(data$chd))
logyoung_chd_univar = coxph(Surv(time_to_chd,chd)~ log_young, data = data)
logyoung_chd_mod1 = coxph(Surv(time_to_chd,chd)~ log_young + age0 + sexe + qm16 + qm10, data = data)
logyoung_chd_mod2 = coxph(Surv(time_to_chd,chd)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10, data = data)
logyoung_chd_mod3 = coxph(Surv(time_to_chd,chd)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10 + bmi, data = data)
logyoung_chd_mod4 = coxph(Surv(time_to_chd,chd)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10 + bmi + mbp, data = data)
```
```{r}
summary(logyoung_chd_univar)
summary(logyoung_chd_mod1)
```

### 3.1.4 aomi
```{r}
data$aomi = as.numeric(as.character(data$aomi))
logyoung_aomi_univar = coxph(Surv(time_to_aomi,aomi)~ log_young, data = data)
logyoung_aomi_mod1 = coxph(Surv(time_to_aomi,aomi)~ log_young + age0 + sexe + qm16 + qm10, data = data)
logyoung_aomi_mod2 = coxph(Surv(time_to_aomi,aomi)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10, data = data)
logyoung_aomi_mod3 = coxph(Surv(time_to_aomi,aomi)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10 + bmi, data = data)
logyoung_aomi_mod4 = coxph(Surv(time_to_aomi,aomi)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10 + bmi + mbp, data = data)
```


### 3.1.5 tdr
```{r}
data$tdr = as.numeric(as.character(data$tdr))
logyoung_tdr_univar = coxph(Surv(time_to_tdr,tdr)~ log_young, data = data)
logyoung_tdr_mod1 = coxph(Surv(time_to_tdr,tdr)~ log_young + age0 + sexe + qm16 + qm10, data = data)
logyoung_tdr_mod2 = coxph(Surv(time_to_tdr,tdr)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10, data = data)
logyoung_tdr_mod3 = coxph(Surv(time_to_tdr,tdr)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10 + bmi, data = data)
logyoung_tdr_mod4 = coxph(Surv(time_to_tdr,tdr)~ log_young + age0 + sexe + qm16 +  qm10 + diab + bio10 + bmi + mbp, data = data)
```





